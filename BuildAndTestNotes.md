## Table of Contents ##

  * [Build Notes](#Build_Notes.md)
    * [Services](#Services.md)
      * [Services Build Targets](#Services_Build_Targets.md)
      * [Building Services on a local machine](#Building_Services_on_a_local_machine.md)
    * [Client](#Client.md)
      * [Client Build Targets](#Client_Build_Targets.md)
      * [Building Client on a local machine](#Building_Client_on_a_local_machine.md)
    * [Database](#Database.md)
      * [Setup a local instance of wikigraph database](#Setup_a_local_instance_of_wikigraph_database.md)
    * [Hudson](#Hudson.md)

# Build Notes #

Instructions for setting up a machine for build different parts of the WikiGraph product. Also includes some words about testing configuration.

All builds packages include a file called version.php with the following contents:
```
<?php
/*
    WikiGraph
    Copyright (c) 2011
    
    *** This file was generated by the WikiGraph automated build system. ***
*/
$VERSION = "$BUILD_TAG -- $BUILD_ID";
echo $VERSION;
?>
```

$BUILD\_TAG and $BUILD\_ID are parameter that the Hudson CI service produces for each build. $BUILD\_TAG takes the form `<Project-Name>-<Build-Number>`. $BUILD\_ID is a date/time string.

They can be accessed by adding version to the end of the major WikiGraph endpoints. This allows developers (and potentially customers) to easily discover what build has been deployed to a given location.

  * [graph/version/](http://wikigraph.cs.washington.edu/graph/version/)
  * [test/version/](http://wikigraph.cs.washington.edu/test/version/)
  * [api/version/](http://wikigraph.cs.washington.edu/api/version/)
  * [test-api/version/](http://wikigraph.cs.washington.edu/test-api/version/)

## Services ##

The services build runs the PHPUnit unit tests, then packages all of the necessary php files with an appropriate config.php file into a tar ball (with the name $(BUILDTAG).tar.gz). On Hudson this tar ball get placed in `WikiMap-M/builds/<PROJECT>/` directory.

The config.php file mentioned previously contains the database connection parameters. Since those values have no place in a public repository, they are kept in the `WikiMap-M/config/` directory on cubist. Hudson has been directored to copy the appropriate config from there during services builds.

There are two ways to specify the database parameters to the build.

  1. Set `CONFIG=/some/path/to/a/config.php` on the command line
    * this will copy your config to the appropriate location for running unit tests during the build
    * it will include a copy of your config.php in the output package (making deployment easier)
  1. Set the parameters `DBHOST`, `DBUSER`, `DBPASS`, `DBNAME`, and `LINKURL` on the command line
    * this will create a config.php with values provided and use it during unit testing
    * it will include a copy of the generated config.php in the output package

### Services Build Targets ###

The relevant build targets for the services are:

| **Command** | **Description** |
|:------------|:----------------|
| `make clone` | Clones the repo, although it is not particularly useful since you need a clone in order to have the Makefile...|
| `make clean` | Removes the ./build directory. It will not remove packages that were output to a directory outside of ./build |
| `make checkapi` | Runs the services unit tests located in `sevices/test/`. While this produces console output, the jUnit like test results are piped into `build/phpunit-log/`. Hudson uses these to chart failures (and successes) over time. |
| `make api` | Pulls and updates the release branch of the repository, runs the unit tests, and packages the php files with a config into the OUTPUT directory. |
| `make hudsonapi` | Uses the release branch (assumes that the repo has already been updated), runs the unit tests, and packages the php files with a config into the OUTPUT directy. |
| `make testapi` | Pulls and updates the dev branch of the repository, runs the unit tests, and packages the php files with a config into the OUTPUT directory. |
| `make hudsontestapi` | Uses the dev branch (assumes that the repo has already been updated), runs the unit tests, and packages the php files with a config into the OUTPUT directy. |

These are the optional parameters for the build:

`[OUTPUT=.] [BUILDTAG=unknown-WikiGraph-unknown] [CONFIG=<config.php>] [TESTCONFIG=<config.php>] [CLIENTCONFIG=<Config.as>] [DBHOST=localhost DBPORT= DBUSER=root DBPASS= DBNAME=wikigraph LINKURL=http://en.wikipedia.org/wiki/ TESTDBHOST=localhost TESTDBPORT= TESTDBUSER=root TESTDBPASS= TESTDBNAME=wikigraph TESTLINKURL=http://en.wikipedia.org/wiki/]`

### Building Services on a local machine ###

It is always useful to be able to build and run certain things locally (for one thing is removes the need to deploy in order to test).

If you do decide to build the services locally, you will need the following software. See [ToolsAndDocs](ToolsAndDocs.md) for more information:

  * PHP 5.3.5+ (command line)
  * PHPUnit 3.4
  * xmllint v.20707
  * make
  * hg

This build system does not support Windows environments. It does work on Fedora, Ubuntu, and most `*`nix environments with the above software.

You will need to provide a valid config.php or the appropriate connection parameters for the unit tests to run successfully. It may be advantageous to setup a [local instance of the wikigraphtest database](http://code.google.com/p/wiki-map-uw-cse/w/BuildAndTestNotes#Setup_a_local_instance_of_wikigraph_database).

## Client ##

The client build compiles the WikiGraph.swf file, a TestRunner.swf file, runs the unit tests, rebuilds the WikiGraph.swf with a stricter configuration (for security reasons), packages the WikiGraph.swf and the index.html wrapper into a tarball and puts them into `$(OUTPUT)/$(PROJECT)/$(BUILDTAG).tar.gz`. On Hudson this tar ball get placed in `WikiMap-M/builds/<PROJECT>/` directory.

The configuration required to build the client is complicated (to say the least). The unit test framework, FlexUnit, runs tests by executing a `*`.swf file and recording output. This requires a display. In Ubuntu and Fedora, Xvnc can be used to emulate a needed display. See building client locally for more information on build dependencies.

In addition to a display emulator (Xvnc), the system must have the Flex 4.1.0 SDK installed. The flex bin directory must be on your path and the build environment must include the parameter FLEX\_HOME, which points the root directory of the flex install on the system. For example, on cubist flex is installed to `WikiMap-M/sandbox/flex`. So, Hudson uses `FLEX_HOME=WikiMap-M/sandbox/flex` and `PATH=$PATH:$FLEX_HOME/bin`.

The default Config.as at `client/FlexClient/DrawGraph/src/Config.as` uses the specific domain `http://wikigraph.cs.washington.edu/` Our binaries are built with special configs (see `client/FlexClient/DrawGraph/config`) that use relative urls. This means that the client must be deployed to the same domain and same path level as the services. For example, if the client is deployed to `/var/www/WikiGraph/graph`, the services would need to be deployed to `/var/www/WikiGraph/api`. If you would like to use a different setup, the Config.as file must be modified.

### Client Build Targets ###

The relevant build targets for the client are:

| **Command** | **Description** |
|:------------|:----------------|
| `make clone` | Clones the repo, although it is not particularly useful since you need a clone in order to have the Makefile...|
| `make clean` | Removes the ./build directory. It will not remove packages that were output to a directory outside of ./build |
| `make checkclient` | Compiles the SWFs and runs the client unit tests located in `client/FlexClient/DrawGraph/test/`. Three forms of output are produced: (1) The results are printed to the console, (2) A gui window open (briefly) where an analysis of the results is displayed (useful for local builds, and (3) jUnit like test results are piped into `build/flexunit-log/`. Hudson uses jUnit like files to chart failures (and successes) over time. |
| `make graph` | Pulls and updates the release branch of the repository, runs the unit tests, and packages the SWF and any wrapper HTML/CSS/JS into the OUTPUT directory. |
| `make hudsongraph` | Uses the release branch (assumes that the repo has already been updated), runs the unit tests, and packages the SWF and any wrapper HTML/CSS/JS into the OUTPUT directory. |
| `make test` | Pulls and updates the dev branch of the repository, runs the unit tests, and packages the SWF and any wrapper HTML/CSS/JS into the OUTPUT directory. |
| `make hudsontest` | Uses the dev branch (assumes that the repo has already been updated), runs the unit tests, and packages the SWF and any wrapper HTML/CSS/JS into the OUTPUT directory. |

These are the optional parameters for the build:

`[OUTPUT=.] [BUILDTAG=unknown-WikiGraph-unknown] [CONFIG=<config.php>] [TESTCONFIG=<config.php>] [CLIENTCONFIG=<Config.as>] [DBHOST=localhost DBPORT= DBUSER=root DBPASS= DBNAME=wikigraph LINKURL=http://en.wikipedia.org/wiki/ TESTDBHOST=localhost TESTDBPORT= TESTDBUSER=root TESTDBPASS= TESTDBNAME=wikigraph TESTLINKURL=http://en.wikipedia.org/wiki/]`

### Building Client on a local machine ###

The easiest way, by far, to run simple acceptance passes on the flash client is to develop in FlashDevelop and use its built in build and play features.

WikiGraph provides little support for the following setup as it is extremely sensitive and complicated. It is how our continuous integration build server is configured. Our developers, however, use FlashDevelop to build the WikiGraph.swf file locally and to run the unit tests. Just set the `test/DeveloperTest.mxml` file to 'Always Compile' in the project manager. Building and playing the project will then display the unit test results in the Adobe Test Result GUI.

Information and links about this and other software is on the [ToolsAndDocs](ToolsAndDocs.md) page.

It is also possible to run the following commands from the `client/FlexClient/DrawGraph/` directory:
```
ant test    # compiles TestRunner.swf and runs tests, depends compile
ant compile # compiles WikiGraph.swf, depends on init
ant clean   # remove the output director from DrawGraph
```

That runs the unit tests and compiles the SWFs into `client/FlexClient/DrawGraph/output/bin/` and the test results into `client/FlexClient/DrawGraph/output/report/`. An HTML file is produced to easily view the test results.

Information and links about this and other software is on the [ToolsAndDocs](ToolsAndDocs.md) page.

In order to run the make commands on a local system, the following software is required:

  * make
  * ant
  * Flex 4.1.0
  * Adobe Flash Player Projector Debugger

Your system also requires the following configuration:

  * FLEX\_HOME must be set to the location of your flex install.
  * FLEX\_HOME/bin must be on your PATH (or Path)
  * Flash Player Project Debugger must be your default application for viewing `*`.swf files
    * On Windows: Control Panel > Programs > Default Programs > Set Associations
    * On Linux: download the flash player projector debugger and put it in a known location. Then create a softlink with the name gflashplayer to the executable. Make sure that gflashplayer is on your path.
  * Open up a browser and navigate to [Flash Global Security Setting Panel](http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html) and add the location of your repo to trusted files.

If you manage to accomplish all of this, you should be able to run `make checkclient` from the command line and have it work. The other build target will work if `make checkclient` works.

**NOTE**: this configuration is not quite right for local builds on cubist. Once Xvnc is installed, the document will be updated to represent the actual configuration on cubist.

## Database ##

In an effort to stream line the tedious process of downloading database dumps and abstracts, a build file has been setup for updating the database in a single step.

Located in the `database/` directory of the repo is a Makefile which can download the latest database dump from wikipedia (or elsewhere), parse the abstract files, add the dump to the WikiGraph database, remove unneeded table/rows/columns, and create the appropriate schema for WikiGraph.

The default source is enwiki (which is the wikipedia dump). By setting the SRC flag in the Makefile, other sources can be used. One other example would be SRC=enwikibooks.

To execute the build, simply run `make` or `make all` (the default target).

Note that this can be use to install a dump for the first time or update it as new dumps are generated.

### Setup a local instance of wikigraph database ###

See the [ToolsAndDocs](ToolsAndDocs.md) page for useful tools for working with MySQL (and other things).

This requires:

  * MySQL 5.1+
  * PHP 5.3.5 on the command line

Create a database for this:
```
CREATE DATABASE `vandot_wgtest`;
```

Set the mysql connection params at the top of the Makefile (in `database/`).
```
USER = vandot
PASS = <your-mysql-passwd>
HOST = localhost
PORT = 3306
DB  = vandot_wgtest
```

Determine a reasonable size source (SRC) for your install. enwikibooks is about 10MB of data, total (compressed). All available dumps are at [WikiMedia Dump page](http://dumps.wikimedia.org/backup-index.html). enwikibooks only has one abstract.xml page as you can see on the [Dump Progress page](http://dumps.wikimedia.org/enwikibooks/20110205/), so MULTIABSTRACT can be commented out.
```
# Possible SRC's:
# enwikibooks
# enwiki
SRC = enwikibooks

# Comment out the next line if the dump only has one abstract.xml file
# MULTIABSTRACT = true

BASE_LINK = http://dumps.wikimedia.org/$(SRC)/latest/
LINK = $(BASE_LINK)$(SRC)-latest-
SQLFILES = page.sql pagelinks.sql
```

Now run `make` and sit back and wait. On cubist, it took about 10 minutes to complete enwikibooks.

## Hudson ##

The WikiGraph team has setup the Hudson Continuous Integration service on cubist (url below). This system automatically polls the repository every three minutes. For each project, it recognizes certain changes as need to rebuild. For example, the WikiGraph-FlashClient project recognizes any change in the client module of the repo and executes a build.

Hudson uses the Makefile at the root of the repo to execute builds. All of our project produce jUnit style result document reports, in addition to standard console output. These reports are used to chart successes and failures on Hudson

The following commands are executed at buildtime for each project. Hudson takes care of updating the repository and setting up the environment (as described in Build and Test Notes wiki page). It also provides several environmental parameters, like $BUILD\_TAG, that can be used to identify the build.

| **Project** | **Description** |
|:------------|:----------------|
| WikiGraph-FlashClient | Builds the Flash client for production ([graph/](http://wikigraph.cs.washington.edu/graph/)) |
| WikiGraph-Services | Builds the Services for production ([api/](http://wikigraph.cs.washington.edu/api/)) |
| WikiGraph-Test-FlashClient | Builds and deploys the Flash client for testing ([test/](http://wikigraph.cs.washington.edu/test/)) |
| WikiGraph-Test-Services | Builds and deploys the Services for testing ([test-api/](http://wikigraph.cs.washington.edu/test-api/)) |

The following commands are executed at buildtime for each project. Hudson takes care of updating the repository and setting up the environment (as described in Build and Test Notes wiki page). It also provides several environmental parameters, like $BUILD\_TAG, that can be used to identify the build.

| **Project** | **Build Command** |
|:------------|:------------------|
| WikiGraph-FlashClient | `make hudsongraph BUILDTAG=$BUILD_TAG BUILDID=$BUILD_ID OUTPUT=<path>/WikiMap-M/builds CLIENTCONFIG=<path>/WikiMap-M/config/TestConfig.as` |
| WikiGraph-Services | `make hudsonapi BUILDTAG=$BUILD_TAG BUILDID=$BUILD_ID OUTPUT=<path>/WikiMap-M/builds CONFIG=<path>/WikiMap-M/config/release-config.php TESTCONFIG=<path>/WikiMap-M/config/unittest-config.php` |
| WikiGraph-Test-FlashClient | `make hudsontest BUILDTAG=$BUILD_TAG BUILDID=$BUILD_ID OUTPUT=<path>/WikiMap-M/builds CLIENTCONFIG=<path>/WikiMap-M/config/ReleaseConfig.as` |
| WikiGraph-Test-Services | `make hudsontestapi BUILDTAG=$BUILD_TAG BUILDID=$BUILD_ID OUTPUT=<path>/WikiMap-M/builds CONFIG=<path>/WikiMap-M/config/test-config.php TESTCONFIG=<path>/WikiMap-M/config/unittest-config.php` |